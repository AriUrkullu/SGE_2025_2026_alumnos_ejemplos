@page "/"

@using System.Reflection
@using System.Text.Json
@inject IJSRuntime JS

<h1>CRUD Json</h1>

<div style="overflow-x:auto;">
    <table class="table table-sm table-striped" style="width:100%; font-size:14px;">
        <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th style="text-align:center;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var producto in productos)
            {
                <tr>
                    <td>@producto.Id</td>
                    <td>@producto.Nombre</td>
                    <td>@producto.Cantidad</td>
                    <td>@producto.Precio.ToString("C")</td>
                    <td style="text-align:center;">
                        <button class="btn btn-sm btn-primary me-1"
                                @onclick="() => EditarProducto(producto)">
                            ✏️
                        </button>
                        <button class="btn btn-sm btn-danger"
                                @onclick="() => EliminarProducto(producto.Id)">
                            🗑️
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="container mt-3">
    <h3 class="mb-4 text-center">
        @(productoeditado.Id == 0 ? "Nuevo Producto" : "Editar Producto")
    </h3>

    <form>
        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input class="form-control" @bind="productoeditado.Nombre" placeholder="Nombre del producto" />
        </div>

        <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" class="form-control" @bind="productoeditado.Cantidad" placeholder="Cantidad" />
        </div>

        <div class="mb-3">
            <label class="form-label">Precio</label>
            <input type="number" step="0.01" class="form-control" @bind="productoeditado.Precio" placeholder="Precio (€)" />
        </div>

        <div class="d-grid">
            <button type="button" class="btn btn-success btn-lg" @onclick="GuardarProducto">
                💾 Guardar
            </button>
        </div>
    </form>
</div>

@code {
    private producto productoeditado = new producto();
    private List<producto> productos = new List<producto>();
    string? mensaje;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Primero intentamos leer desde AppDataDirectory (si ya existe)
            var path = Path.Combine(FileSystem.AppDataDirectory, "productos.json");
            mensaje = path;
            if (File.Exists(path))
            {
                var json = await File.ReadAllTextAsync(path);
                productos = JsonSerializer.Deserialize<List<producto>>(json) ?? new List<producto>();
            }
            else
            {
                // Si no existe, cargamos el archivo inicial desde Resources/raw
                using var stream = await FileSystem.OpenAppPackageFileAsync("productos.json");
                using var reader = new StreamReader(stream);
                var json = reader.ReadToEnd();
                productos = JsonSerializer.Deserialize<List<producto>>(json) ?? new List<producto>();
                // Guardamos una copia editable en AppDataDirectory
                await File.WriteAllTextAsync(path, json);
            }
        }
        catch (Exception ex)
        {
            productos = new List<producto>();
        }
    }

    private async Task GuardarProductos()
    { // metodo para guardar cambios
        var path = Path.Combine(FileSystem.AppDataDirectory, "productos.json");
        var json = JsonSerializer.Serialize(productos, new JsonSerializerOptions { WriteIndented = true });
        await File.WriteAllTextAsync(path, json);
    }

    private async Task GuardarProducto()
    {
        if (productoeditado.Id == 0)
        { //si el producto es nuevo
            productoeditado.Id = productos.Any() ? productos.Max(p => p.Id) + 1 : 1;
            productos.Add(productoeditado);
        }
        else
        { //si el producto ya existe, lo modificamos
            var index = productos.FindIndex(p => p.Id == productoeditado.Id);
            if (index >= 0) productos[index] = productoeditado;
        }

        await GuardarProductos();
        productoeditado = new producto();
    }

   
    private void EditarProducto(producto producto)
    {
        productoeditado = new producto
        {
            Id = producto.Id,
            Nombre = producto.Nombre,
            Cantidad = producto.Cantidad,
            Precio = producto.Precio
        };
    }

    private async Task EliminarProducto(int id)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm", $"¿Seguro que quieres eliminar el producto {id}?");
        if (confirmar)
        {
            productos.RemoveAll(p => p.Id == id);
            await GuardarProductos();
        }
    }
}
